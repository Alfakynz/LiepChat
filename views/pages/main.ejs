<!DOCTYPE html>
<html lang="en">

<head>
  <%- include('../components/head', { title: text['chat'] }) %>
</head>

<body>
  <%- include('../components/header', { title: text['chat'] }) %>
    <main>
      <section>
        <a href="/profile">
          <%= text['profile'] %>
        </a>
      </section>
      <section>
        <h3>
          <span id="connectedUsers">0</span>
        </h3>
      </section>
      <section>
        <ul id="messages"></ul>
      </section>
      <section>
        <form id="form" action="">
          <input type="text" id="inputMsg" />
          <button class="send">
            <%= text['send'] %>
          </button>
        </form>
      </section>
    </main>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      document.addEventListener("DOMContentLoaded", () => {
        socket.emit('page', 'chat', '<%= user.username %>');
      });

      socket.on('chat message', (data) => {
        const messages = document.getElementById('messages');
        const newMessage = document.createElement('li');
        newMessage.innerHTML = data;
        messages.appendChild(newMessage);
        window.scrollTo(0, document.body.scrollHeight);
      });

      socket.on("connectedUsers", (users) => {
        document.getElementById('connectedUsers').textContent = users.length;
      });

      document.querySelector('form').addEventListener('submit', (event) => {
        event.preventDefault();
        const message = document.getElementById('inputMsg').value;
        socket.emit('chat message', message, '<%= user.username %>', '<%= user.color %>');
        document.getElementById('inputMsg').value = '';
      });

      window.addEventListener('beforeunload', () => {
        isDisconnected = true;
        socket.emit('disconnection', '<%= user.username %>');
      });

      window.addEventListener('unload', () => {
        if (!isDisconnected) {
          socket.emit('disconnection', '<%= user.username %>');
        }
      });
    </script>
</body>

</html>